# 数据库配置指南

## 📊 数据库架构

本系统使用MySQL 8.0数据库，包含以下表：

### 核心数据表

1. **用户表 (sys_user)** - 存储系统用户
2. **药品表 (medicine)** - 存储药品信息
3. **入库记录表 (stock_in)** - 药品入库记录
4. **出库记录表 (stock_out)** - 药品出库记录
5. **处方表 (prescription)** - 处方信息
6. **处方明细表 (prescription_detail)** - 处方中的药品明细
7. **审核记录表 (audit_record)** - 药品审核记录

---

## 🔧 配置步骤

### 1. 安装MySQL 8.0

**下载地址**: https://dev.mysql.com/downloads/mysql/

**安装选项**:
- 选择 "Developer Default"
- 设置root密码为: `123456`
- 启用所有服务

### 2. 创建数据库

打开MySQL命令行或MySQL Workbench，执行：

```sql
-- 创建数据库
CREATE DATABASE hpims CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE hpims;
```

### 3. 执行初始化脚本

**方法一：命令行方式**
```bash
mysql -u root -p < database/init.sql
```

**方法二：MySQL Workbench**
1. 打开MySQL Workbench
2. 连接到localhost
3. 打开文件 `database/init.sql`
4. 点击执行按钮

---

## 📋 数据表结构

### 用户表 (sys_user)
```sql
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'administrator',
    real_name VARCHAR(50),
    department VARCHAR(50),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 药品表 (medicine)
```sql
CREATE TABLE medicine (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    generic_name VARCHAR(100),
    specification VARCHAR(50),
    manufacturer VARCHAR(100),
    price DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    stock_quantity INT NOT NULL DEFAULT 0,
    min_stock INT DEFAULT 10,
    category VARCHAR(50),
    approval_number VARCHAR(50),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 入库记录表 (stock_in)
```sql
CREATE TABLE stock_in (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    medicine_id BIGINT NOT NULL,
    batch_number VARCHAR(50),
    quantity INT NOT NULL,
    supplier VARCHAR(100),
    in_date DATE NOT NULL,
    operator VARCHAR(50),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (medicine_id) REFERENCES medicine(id)
);
```

### 出库记录表 (stock_out)
```sql
CREATE TABLE stock_out (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    medicine_id BIGINT NOT NULL,
    batch_number VARCHAR(50),
    quantity INT NOT NULL,
    out_date DATE NOT NULL,
    operator VARCHAR(50),
    reason VARCHAR(100),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (medicine_id) REFERENCES medicine(id)
);
```

### 处方表 (prescription)
```sql
CREATE TABLE prescription (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    prescription_number VARCHAR(50) NOT NULL UNIQUE,
    patient_name VARCHAR(50) NOT NULL,
    patient_age INT,
    patient_gender VARCHAR(10),
    doctor_name VARCHAR(50),
    department VARCHAR(50),
    create_date DATE NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT '未审核',
    audit_result TEXT,
    audit_time TIMESTAMP NULL,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 处方明细表 (prescription_detail)
```sql
CREATE TABLE prescription_detail (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    prescription_id BIGINT NOT NULL,
    medicine_id BIGINT NOT NULL,
    quantity INT NOT NULL,
    dosage VARCHAR(100),
    frequency VARCHAR(50),
    days INT,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (prescription_id) REFERENCES prescription(id),
    FOREIGN KEY (medicine_id) REFERENCES medicine(id)
);
```

### 审核记录表 (audit_record)
```sql
CREATE TABLE audit_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    prescription_id BIGINT NOT NULL,
    audit_type VARCHAR(20) DEFAULT '自动审核',
    audit_result VARCHAR(20) NOT NULL,
    audit_score DECIMAL(5,2),
    issues_found TEXT,
    suggestions TEXT,
    auditor VARCHAR(50),
    audit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (prescription_id) REFERENCES prescription(id)
);
```

---

## 🎯 初始测试数据

数据库初始化后会自动创建以下测试数据：

### 默认用户
```sql
INSERT INTO sys_user (username, password, role) VALUES
('admin', '123456', 'admin');
```

### 测试药品
```sql
INSERT INTO medicine (name, specification, manufacturer, price, stock_quantity) VALUES
('阿莫西林胶囊', '0.25g*24粒', '哈药集团', 15.50, 100),
('布洛芬缓释胶囊', '0.3g*20粒', '拜耳医药', 28.80, 50),
('维生素C片', '100mg*100片', '施尔康', 12.90, 200),
('感冒灵颗粒', '10g*12袋', '白云山制药', 8.50, 80);
```

### 测试处方
```sql
INSERT INTO prescription (prescription_number, patient_name, patient_age, doctor_name, create_date, status) VALUES
('RX20241209001', '张三', 35, '李医生', '2024-12-09', '未发药'),
('RX20241209002', '李四', 28, '王医生', '2024-12-09', '已发药');
```

---

## 🔗 连接配置

### Spring Boot配置 (application.yml)
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/hpims?useSSL=false&serverTimezone=UTC&characterEncoding=utf8
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver
```

### Python配置 (settings.py)
```python
DATABASE_CONFIG = {
    'host': 'localhost',
    'user': 'root',
    'password': '123456',
    'database': 'hpims',
    'charset': 'utf8mb4'
}
```

---

## 🛠 数据库管理工具

### 推荐工具：
1. **MySQL Workbench** - 官方GUI工具
2. **Navicat** - 商业GUI工具
3. **phpMyAdmin** - Web界面工具
4. **DBeaver** - 免费开源工具

### 常用命令：
```sql
-- 查看所有数据库
SHOW DATABASES;

-- 选择数据库
USE hpims;

-- 查看所有表
SHOW TABLES;

-- 查看表结构
DESCRIBE medicine;

-- 查询数据
SELECT * FROM sys_user;
SELECT COUNT(*) FROM medicine;
```

---

## 🔍 数据验证

初始化完成后，运行以下查询验证数据：

```sql
-- 检查用户表
SELECT id, username, role FROM sys_user;

-- 检查药品表
SELECT id, name, stock_quantity FROM medicine;

-- 检查处方表
SELECT id, prescription_number, patient_name, status FROM prescription;

-- 检查处方明细
SELECT pd.*, m.name as medicine_name
FROM prescription_detail pd
JOIN medicine m ON pd.medicine_id = m.id;
```

---

## 🚨 故障排除

### 连接失败
1. 检查MySQL服务是否启动
2. 验证用户名和密码
3. 检查防火墙设置

### 字符集问题
确保数据库使用UTF-8字符集：
```sql
ALTER DATABASE hpims CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 权限问题
授予用户权限：
```sql
GRANT ALL PRIVILEGES ON hpims.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

